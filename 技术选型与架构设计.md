# 水印图片处理应用 - 技术选型与架构设计

## 1. 技术选型

### 1.1 前端技术
- **框架**：Vue.js 3.x（编译为静态资源）
- **UI组件库**：Element Plus
- **状态管理**：Vuex
- **图片预览与处理**：使用原生Canvas API或第三方库（如 fabric.js）
- **打包工具**：Vite（构建静态资源）
- **样式**：Sass/SCSS
- **运行容器**：JavaFX WebView

### 1.2 后端技术
- **语言**：Java 17+
- **桌面框架**：JavaFX 17+
- **UI容器**：JavaFX WebView（承载Vue.js界面）
- **图片处理**：Java原生BufferedImage、ImageIO，必要时引入第三方库（如 Thumbnailator、TwelveMonkeys ImageIO扩展）
- **本地数据存储**：SQLite（嵌入式数据库，生成本地.db文件，无需外部服务器）
- **通信方式**：JavaScript ↔ Java Bridge（通过WebView API）
- **日志与监控**：SLF4J + Logback
- **文件管理**：Java NIO（本地文件系统操作）

### 1.3 其他工具与依赖
- **依赖管理**：Maven
- **测试框架**：JUnit 5、Mockito
- **代码质量**：Checkstyle、SpotBugs
- **打包分发**：jpackage（JDK 17+自带）+ launch4j
- **JS-Java通信**：JavaFX WebEngine Bridge API

## 2. 系统架构设计

### 2.1 总体架构

```
┌─────────────────────────────────────────────────────────┐
│                   JavaFX桌面应用                        │
│  ┌─────────────────────────────────────────────────────┐ │
│  │              JavaFX WebView容器                     │ │
│  │  ┌─────────────────────────────────────────────────┐ │ │
│  │  │         Vue.js前端界面（静态资源）               │ │ │
│  │  │      HTML + CSS + JavaScript                    │ │ │
│  │  └─────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────┘ │
│                         │                               │
│                         ▼ JS-Java Bridge               │
│                  Java业务逻辑层                         │
│            (图片处理、水印、SQLite等)                   │
└─────────────────────────────────────────────────────────┘
                         │
                         ▼
                 本地文件系统
           (图片文件 + SQLite数据库)
```

### 2.2 本地存储说明

**SQLite嵌入式数据库**：
- 无需安装数据库服务器，SQLite直接嵌入到Java应用中
- 在应用目录下生成一个 `watermark_app.db` 文件
- 存储内容：水印模板、用户配置、处理历史记录
- 文件位置：`%APPDATA%\WatermarkApp\watermark_app.db`

**文件系统存储**：
- 原始图片：用户选择的文件路径（只读）
- 缩略图缓存：`%APPDATA%\WatermarkApp\thumbnails\`
- 导出图片：用户指定的输出目录
- 临时预览图：系统临时目录，应用关闭时清理

### 2.3 前端模块划分
- **图片导入与列表组件**（Vue组件，编译为静态资源）
- **主预览组件**（Canvas图片预览与拖拽）
- **水印配置面板组件**（实时参数调整）
- **输出设置组件**（导出配置界面）
- **模板管理组件**（模板CRUD操作）
- **全局状态管理**（Vuex，管理应用状态）
- **JavaFX Bridge接口**（与Java后端通信）

### 2.4 后端模块划分
- **JavaFX Application**：主应用程序入口
- **WebView Controller**：管理WebView容器和JS-Java通信
- **Bridge Service**：JavaScript调用的Java方法接口
- **Service层**：业务逻辑（水印处理、批量处理、预览生成）
- **Strategy模式**：水印类型处理（文本/图片）
- **Factory模式**：图片处理器创建
- **Builder模式**：水印参数构建
- **Repository层**：配置与模板持久化（SQLite）
- **Observer模式**：处理进度通知（回调到前端）

### 2.5 关键第三方库
- **前端（Vue静态资源）**：
  - Element Plus（UI组件库）
  - fabric.js（可选，图片编辑/拖拽/旋转）
- **Java后端**：
  - JavaFX WebView（内嵌Web浏览器）
  - Thumbnailator（图片缩放/格式转换）
  - TwelveMonkeys ImageIO（TIFF/BMP等格式支持）
  - SQLite JDBC（本地数据库）
  - Jackson（JSON序列化，JS-Java数据交换）

### 2.6 通信协议
- **前后端通信**：JavaFX WebEngine Bridge API
- **数据格式**：JSON（JavaScript ↔ Java对象序列化）
- **调用方式**：
  - JavaScript调用Java：`window.java.methodName(params)`
  - Java调用JavaScript：`webEngine.executeScript(jsCode)`
- **实时预览**：Java直接更新WebView中的DOM元素

### 2.7 部署与运行
- **开发环境**：
  - Vue项目独立开发调试（`npm run dev`）
  - 构建静态资源集成到JavaFX（`npm run build`）
  - JavaFX应用加载静态资源运行
- **生产环境**：
  - 使用jpackage打包为单一exe文件
  - 双击即可运行，无需安装Java环境
  - 所有资源（Vue静态文件、Java类库、SQLite）打包在一起
- **数据存储**：用户AppData目录下的SQLite文件和缓存目录

## 3. 关键架构图

### 3.1 模块交互流程
```
[用户操作] → [Vue界面(WebView)] → [JS-Java Bridge] → [Java业务逻辑] → [图片处理/SQLite] → [结果回调前端]
```

### 3.2 典型用例流程
- **批量导入图片**：前端文件选择 → JS调用Java方法 → 解析生成缩略图 → 更新前端列表
- **水印配置调整**：前端参数变化 → JS Bridge传递配置 → Java生成预览 → 直接更新WebView图片
- **批量导出图片**：前端发起请求 → Java批量处理 → 进度回调更新前端 → 完成通知
- **模板保存/加载**：前端操作 → JS调用Java SQLite方法 → 数据持久化 → 返回操作结果

## 4. 设计原则
- **单一职责**：每个模块只负责一种功能，易于维护和扩展
- **高内聚低耦合**：前后端分离，接口清晰
- **可扩展性**：水印类型、图片格式、模板等均可扩展
- **易用性**：界面友好，交互流畅
- **安全性**：本地文件安全，防止数据丢失和覆盖

---

**文档版本**: v1.0  
**创建日期**: 2025-09-28  
**最后更新**: 2025-09-28